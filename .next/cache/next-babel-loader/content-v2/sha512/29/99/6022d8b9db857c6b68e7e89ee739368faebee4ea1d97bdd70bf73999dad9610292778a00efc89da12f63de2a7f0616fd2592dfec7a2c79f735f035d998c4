{"ast":null,"code":"import { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport { Avatar, IconButton } from '@material-ui/core';\nimport { useRouter } from 'next/router';\nimport React, { useRef, useState } from 'react';\nimport { useAuthState } from 'react-firebase-hooks/auth';\nimport styled from 'styled-components';\nimport { auth, db } from '../firebase';\nimport AttachFileIcon from '@material-ui/icons/AttachFile';\nimport MoreVertIcon from \"@material-ui/icons/MoreVert\";\nimport { useCollection } from 'react-firebase-hooks/firestore';\nimport Message from './Message';\nimport InsertEmoticonIcon from '@material-ui/icons/InsertEmoticon';\nimport MicIcon from '@material-ui/icons/Mic';\nimport firebase from 'firebase';\nimport getRecipientEmail from '../utils/getRecipientEmail';\nimport TimeAgo from 'timeago-react';\n\nfunction ChatScreen({\n  chat,\n  messages\n}) {\n  var _recipientSnapshot$do, _recipientSnapshot$do2, _recipient$lastSeen, _recipient$lastSeen2;\n\n  const [user] = useAuthState(auth);\n  const endOfMessageRef = useRef(null);\n  const router = useRouter();\n  const {\n    0: input,\n    1: setInput\n  } = useState(\"\");\n  const [messagesSnapshot] = useCollection(db.collection('chats').doc(router.query.id).collection(\"messages\").orderBy(\"timestamp\", \"asc\")); //  console.log(\"i am a problem 1 \", messagesSnapshot);\n\n  const [recipientSnapshot] = useCollection(db.collection('users').where(\"email\", \"==\", getRecipientEmail(chat.users, user)));\n\n  const showMessage = () => {\n    //  console.log(\"i am a problenm2 \", messagesSnapshot);\n    if (messagesSnapshot) {\n      //  console.log(\"i am problem 3 \", messagesSnapshot);\n      return messagesSnapshot.docs.map(message => {\n        var _message$data, _message$data$timesta;\n\n        // console.log(message);\n        return /*#__PURE__*/_jsx(Message, {\n          user: message.data().user,\n          message: _objectSpread(_objectSpread({}, message.data()), {}, {\n            timestamp: (_message$data = message.data()) === null || _message$data === void 0 ? void 0 : (_message$data$timesta = _message$data.timestamp) === null || _message$data$timesta === void 0 ? void 0 : _message$data$timesta.toDate().getTime()\n          })\n        }, message.id);\n      });\n    } else {\n      //  console.log(messagesSnapshot);\n      console.log(messages);\n      return JSON.parse(messages).map(message => {\n        /*#__PURE__*/\n        _jsx(Message, {\n          user: message.user,\n          message: message\n        }, message.id);\n      });\n    }\n  };\n\n  const ScrollToBottom = () => {\n    endOfMessageRef.current.scrollIntoView({\n      behavior: \"smooth\",\n      block: \"start\"\n    });\n  };\n\n  const sendMessage = e => {\n    e.preventDefault();\n    db.collection('users').doc(user.uid).set({\n      lastSeen: firebase.firestore.FieldValue.serverTimestamp()\n    }, {\n      merge: true\n    });\n    db.collection('chats').doc(router.query.id).collection('messages').add({\n      timestamp: firebase.firestore.FieldValue.serverTimestamp(),\n      message: input,\n      user: user.email,\n      photoURL: user.photoURL\n    });\n    setInput(\"\");\n    ScrollToBottom();\n  };\n\n  const recipient = recipientSnapshot === null || recipientSnapshot === void 0 ? void 0 : (_recipientSnapshot$do = recipientSnapshot.docs) === null || _recipientSnapshot$do === void 0 ? void 0 : (_recipientSnapshot$do2 = _recipientSnapshot$do[0]) === null || _recipientSnapshot$do2 === void 0 ? void 0 : _recipientSnapshot$do2.data();\n  const recipientEmail = getRecipientEmail(chat.users, user);\n  return /*#__PURE__*/_jsxs(Container, {\n    children: [/*#__PURE__*/_jsxs(Header, {\n      children: [recipient ? /*#__PURE__*/_jsx(Avatar, {\n        src: recipient === null || recipient === void 0 ? void 0 : recipient.photoUrl\n      }) : /*#__PURE__*/_jsxs(Avatar, {\n        children: [\" \", recipientEmail[0], \" \"]\n      }), /*#__PURE__*/_jsxs(HeaderInformation, {\n        children: [/*#__PURE__*/_jsxs(\"h3\", {\n          children: [\" \", recipientEmail]\n        }), recipientSnapshot ? /*#__PURE__*/_jsxs(\"p\", {\n          children: [\"Last active:\", ' ', recipient !== null && recipient !== void 0 && (_recipient$lastSeen = recipient.lastSeen) !== null && _recipient$lastSeen !== void 0 && _recipient$lastSeen.toDate() ? /*#__PURE__*/_jsx(TimeAgo, {\n            datetime: recipient === null || recipient === void 0 ? void 0 : (_recipient$lastSeen2 = recipient.lastSeen) === null || _recipient$lastSeen2 === void 0 ? void 0 : _recipient$lastSeen2.toDate()\n          }) : \"Unavailable\"]\n        }) : /*#__PURE__*/_jsx(\"p\", {\n          children: \"Loading last active\"\n        })]\n      }), /*#__PURE__*/_jsx(HeaderIcons, {\n        children: /*#__PURE__*/_jsxs(IconButton, {\n          children: [/*#__PURE__*/_jsx(AttachFileIcon, {}), /*#__PURE__*/_jsx(MoreVertIcon, {})]\n        })\n      })]\n    }), /*#__PURE__*/_jsxs(MessageContainer, {\n      className: \"h-screen p-8 bg-red-100\",\n      children: [showMessage(), /*#__PURE__*/_jsx(EndOfMessage, {\n        ref: endOfMessageRef\n      })]\n    }), /*#__PURE__*/_jsxs(InputContainer, {\n      children: [/*#__PURE__*/_jsx(InsertEmoticonIcon, {}), /*#__PURE__*/_jsx(Input, {\n        value: input,\n        onChange: e => setInput(e.target.value)\n      }), /*#__PURE__*/_jsx(\"button\", {\n        disabled: !input,\n        onClick: sendMessage,\n        children: \"Send\"\n      }), /*#__PURE__*/_jsx(MicIcon, {})]\n    })]\n  });\n}\n\nexport default ChatScreen;\nconst Container = styled.div.attrs({\n  className: \"h-screen\"\n})``;\nconst Header = styled.div.attrs({\n  className: \"sticky bg-white z-100 top-0 flex p-2 h-16 items-center border-b-2 border-gray-200\"\n})``;\nconst HeaderInformation = styled.div.attrs({\n  className: \"m-2 flex-1\"\n})``;\nconst HeaderIcons = styled.div.attrs({})``;\nconst MessageContainer = styled.div.attrs({})``;\nconst InputContainer = styled.div.attrs({\n  className: \"flex items-center p-3 sticky bottom-0 bg-white z-50\"\n})``;\nconst Input = styled.input.attrs({\n  className: \"flex-1 outline-none border-none rounded-xl bg-gray-50 p-2 ml-4 mr-4\"\n})``;\nconst EndOfMessage = styled.div.attrs({\n  className: \"m-10\"\n})``;","map":null,"metadata":{},"sourceType":"module"}